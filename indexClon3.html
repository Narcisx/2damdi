<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duolingo Clone - Complete & Dark</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. SISTEMA DE DISE√ëO (DARK MODE VISUAL + VARIABLES ORIGINALES)
           ========================================= */
        :root {
            /* Colores de Marca (Estilo Visual Nuevo) */
            --c-success: #58cc02;     --c-success-sh: #46a302; --c-success-lt: #1b2d23;
            --c-primary: #1cb0f6;     --c-primary-sh: #1899d6;
            --c-chest: #ff9600;       --c-chest-sh: #cc7800;
            --c-error: #ff4b4b;       --c-error-sh: #ea2b2b;   --c-error-lt: #451b1b;
            --c-warning: #ffc800;     --c-gems: #2b70c9;
            --c-purple: #ce82ff;

            /* Tema Oscuro (Base) */
            --bg-body: #131f24;       /* Fondo oscuro de la captura */
            --bg-card: #202f36;       /* Tarjetas/Inputs */
            --c-text: #ffffff;
            --c-text-sub: #52656d;
            --c-border: #37464f;
            --c-locked: #37464f;
            --c-input: #202f36;
            
            --radius: 16px;
            --font: 'Nunito', sans-serif;
            --nav-height: 88px;       /* Altura nav nuevo */
            --header-height: 58px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: var(--font); background: var(--bg-body); color: var(--c-text);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; justify-content: center;
        }

        #app-root {
            width: 100%; max-width: 480px; height: 100%;
            background: var(--bg-body);
            position: relative; display: flex; flex-direction: column;
        }

        /* =========================================
           2. VISTAS Y ESTRUCTURA
           ========================================= */
        .view {
            display: none; flex: 1; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            padding-top: var(--header-height); 
            padding-bottom: var(--nav-height);
        }
        .view.active { display: flex; }
        
        /* Full screen para Login y Lecci√≥n */
        .view.full-screen { 
            padding: 20px; z-index: 200; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: var(--bg-body); 
            padding-top: 20px; padding-bottom: 20px;
        }

        /* =========================================
           3. UI KIT (Botones, Inputs, Cards)
           ========================================= */
        .btn {
            width: 100%; padding: 14px; border-radius: var(--radius);
            border: 2px solid transparent; border-bottom-width: 4px;
            font-weight: 800; text-transform: uppercase; cursor: pointer;
            font-family: var(--font); letter-spacing: 0.8px; margin-bottom: 12px;
            text-align: center; transition: 0.1s;
        }
        .btn:active { transform: translateY(4px); border-bottom-width: 0px; margin-top: 4px; }
        
        .btn-primary { background: var(--c-primary); color: white; border-color: var(--c-primary-sh); }
        .btn-success { background: var(--c-success); color: white; border-color: var(--c-success-sh); }
        .btn-outline { background: transparent; border: 2px solid var(--c-border); border-bottom-width: 4px; color: var(--c-text-sub); }
        
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-field {
            width: 100%; padding: 15px; border: 2px solid var(--c-border);
            border-radius: var(--radius); background: var(--c-input);
            color: var(--c-text); font-family: var(--font); font-size: 1rem; outline: none;
        }
        .input-field:focus { border-color: var(--c-primary); background: #2a3b44; }

        /* FLIP CARDS (Recuperado para Pr√°ctica) */
        .flip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .flip-card { height: 160px; perspective: 1000px; cursor: pointer; }
        .flip-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
            border-radius: var(--radius); box-shadow: 0 4px 0 var(--c-border);
        }
        .flip-card.flipped .flip-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; border-radius: var(--radius);
            border: 2px solid var(--c-border); background: var(--bg-card);
            font-weight: 700; color: var(--c-text);
        }
        .flip-back { transform: rotateY(180deg); background: var(--bg-card); color: var(--c-primary); border-color: var(--c-primary); }

        /* =========================================
           4. HOME VISUALS (Header, Banner, Map)
           ========================================= */
        /* Header Stats */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-body); z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; border-bottom: 2px solid var(--c-border);
        }
        .stat-item { display: flex; align-items: center; gap: 6px; font-weight: 800; font-size: 1rem; }
        .stat-fire { color: #ff9600; } 
        .stat-gem { color: #1cb0f6; }   
        .stat-heart { color: #ff4b4b; }

        /* Green Banner */
        .section-banner {
            background: var(--c-success); padding: 18px 16px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Map Nodes (Zig Zag) */
        .map-container { display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
        
        .map-node {
            position: relative; width: 80px; height: 80px; margin: 8px 0;
            display: grid; place-items: center; cursor: pointer;
        }
        .node-circle {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--c-success); box-shadow: 0 8px 0 var(--c-success-sh);
            display: grid; place-items: center; z-index: 2; position: relative;
        }
        .map-node.locked .node-circle { background: var(--c-locked); box-shadow: none; pointer-events: none; }
        .map-node.current { animation: bounce 2s infinite; }
        .star-icon path { fill: white; }
        .map-node.locked .star-icon path { fill: #52656d; opacity: 0.5; }

        /* B√∫ho Decoraci√≥n */
        .owl-decoration {
            width: 90px; height: 80px; margin: 10px 0;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%2358cc02' d='M20,40 Q10,40 10,60 Q10,90 50,90 Q90,90 90,60 Q90,40 80,40 Z'/%3E%3Ccircle cx='35' cy='50' r='12' fill='white'/%3E%3Ccircle cx='65' cy='50' r='12' fill='white'/%3E%3Ccircle cx='35' cy='50' r='5' fill='black'/%3E%3Ccircle cx='65' cy='50' r='5' fill='black'/%3E%3Cpath fill='%23ffc800' d='M45,60 L55,60 L50,68 Z'/%3E%3C/svg%3E") no-repeat center;
            background-size: contain;
        }

        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
            40% {transform: translateY(-8px);} 
            60% {transform: translateY(-4px);} 
        }

        /* =========================================
           5. GAME & NAV
           ========================================= */
        .option-btn {
            background: var(--bg-card); border: 2px solid var(--c-border);
            border-bottom-width: 4px; border-radius: 12px; padding: 16px;
            text-align: center; font-size: 1.1rem; font-weight: 700; cursor: pointer; color: var(--c-text);
            margin-bottom: 10px;
        }
        .option-btn.selected { border-color: var(--c-primary); background: rgba(28, 176, 246, 0.15); color: var(--c-primary); }
        .option-btn.correct { border-color: var(--c-success); background: var(--c-success-lt); color: var(--c-success); }
        .option-btn.wrong { border-color: var(--c-error); background: var(--c-error-lt); color: var(--c-error); }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 480px;
            height: var(--nav-height); background: var(--bg-body);
            border-top: 2px solid var(--c-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: 10px;
        }
        .nav-item { flex: 1; display: flex; justify-content: center; align-items: center; height: 100%; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; }
        .nav-icon-svg { width: 32px; height: 32px; }
        .nav-item.active .nav-icon-svg path { fill: var(--c-success); stroke: none; }
        .nav-item:not(.active) .nav-icon-svg path { fill: transparent; stroke: var(--c-text-sub); stroke-width: 3; stroke-linecap: round; }

        /* Auth Tabs */
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; }
        .auth-tab { 
            flex: 1; padding: 10px; text-align: center; font-weight: 800; 
            color: var(--c-text-sub); border-bottom: 2px solid var(--c-border); 
            cursor: pointer; text-transform: uppercase;
        }
        .auth-tab.active { color: var(--c-primary); border-color: var(--c-primary); }

    </style>
</head>
<body>

    <div id="app-root">

        <div id="lang-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center;">
            <div style="background:var(--bg-card); padding:20px; border-radius:20px; width:300px; max-height:80vh; overflow-y:auto;">
                <h3 style="text-align:center; margin-top:0;">Cursos</h3>
                <div id="lang-list"></div>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="App.ui.toggleLang(false)">CERRAR</button>
            </div>
        </div>

        <section id="view-auth" class="view full-screen active" style="justify-content:center; align-items:center;">
            <div style="text-align:center; width:100%; max-width:320px;">
                <svg width="100" height="100" viewBox="0 0 100 100" style="margin-bottom:20px;">
                    <path fill="#58cc02" d="M20,40 Q10,40 10,60 Q10,90 50,90 Q90,90 90,60 Q90,40 80,40 Z"/>
                    <circle cx="35" cy="50" r="12" fill="white"/> <circle cx="65" cy="50" r="12" fill="white"/>
                    <circle cx="35" cy="50" r="5" fill="black"/> <circle cx="65" cy="50" r="5" fill="black"/>
                    <path fill="#ffc800" d="M45,60 L55,60 L50,68 Z"/>
                </svg>
                <h2 style="color:var(--c-success); margin-bottom:20px;">Duolingo Clone</h2>

                <div class="auth-tabs">
                    <div class="auth-tab active" id="tab-login" onclick="App.auth.switchTab('login')">INGRESAR</div>
                    <div class="auth-tab" id="tab-register" onclick="App.auth.switchTab('register')">REGISTRAR</div>
                </div>

                <form onsubmit="event.preventDefault(); App.auth.submit();">
                    <div class="input-group">
                        <input type="text" id="auth-user" class="input-field" placeholder="Usuario" required autocomplete="off" autocapitalize="none">
                    </div>
                    <div class="input-group">
                        <input type="password" id="auth-pass" class="input-field" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btn-auth-action">INICIAR SESI√ìN</button>
                </form>
                <p id="auth-error" style="color:var(--c-error); font-weight:bold; min-height:20px;"></p>
            </div>
        </section>

        <section id="view-home" class="view">
            <header class="top-bar">
                <div class="stat-item" onclick="App.ui.toggleLang(true)">
                    <span id="flag-icon" style="font-size:1.5rem;">üá∫üá∏</span>
                </div>
                <div class="stat-item stat-fire">
                    <span style="font-size:1.2rem;">üî•</span> <span id="dash-streak">0</span>
                </div>
                <div class="stat-item stat-gem">
                    <span style="font-size:1.2rem;">üíé</span> <span id="dash-xp">0</span>
                </div>
                <div class="stat-item stat-heart">
                    <span style="font-size:1.2rem;">‚ù§Ô∏è</span> 5
                </div>
            </header>

            <div class="section-banner">
                <div class="section-info">
                    <h4 style="margin:0; color:#b6f386; font-size:0.8rem; text-transform:uppercase;">Etapa 1, Secci√≥n 1</h4>
                    <h2 style="margin:5px 0 0 0; color:white;">Primeros Pasos</h2>
                </div>
                <div style="background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:12px; border:2px solid rgba(255,255,255,0.2);">
                    üìñ
                </div>
            </div>

            <div id="level-map-container" class="map-container"></div>
        </section>

        <section id="view-practice" class="view">
            <div style="padding:0 20px;">
                <h2 style="color:var(--c-primary);">Repaso de Palabras</h2>
                <p style="color:var(--c-text-sub);">Gira las tarjetas para practicar tu vocabulario.</p>
            </div>
            <div class="flip-grid" id="vocab-grid"></div>
        </section>

        <section id="view-profile" class="view">
            <div style="padding:20px;">
                <div style="display:flex; align-items:center; gap:20px; margin-bottom:30px; border-bottom:2px solid var(--c-border); padding-bottom:20px;">
                    <div style="width:80px; height:80px; background:var(--c-purple); border-radius:50%; display:grid; place-items:center; font-size:2rem; color:white; font-weight:bold;" id="profile-avatar">U</div>
                    <div>
                        <h2 id="profile-name" style="margin:0;">Usuario</h2>
                        <p style="margin:5px 0; color:var(--c-text-sub);">¬°Estudiante Legendario!</p>
                        <button class="btn btn-outline" style="padding:5px 10px; font-size:0.8rem;" onclick="App.auth.logout()">CERRAR SESI√ìN</button>
                    </div>
                </div>

                <h3>Estad√≠sticas</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div style="background:var(--bg-card); border:2px solid var(--c-border); padding:15px; border-radius:var(--radius);">
                        üî• <span id="profile-streak">0</span> <br><small style="color:var(--c-text-sub)">Racha d√≠as</small>
                    </div>
                    <div style="background:var(--bg-card); border:2px solid var(--c-border); padding:15px; border-radius:var(--radius);">
                        üíé <span id="profile-xp">0</span> <br><small style="color:var(--c-text-sub)">Gemas Total</small>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-lesson" class="view full-screen" style="z-index:300;">
            <header style="display:flex; align-items:center; margin-bottom:20px;">
                <button onclick="App.game.quit()" style="background:none; border:none; font-size:1.5rem; color:var(--c-text-sub); cursor:pointer;">‚úï</button>
                <div style="flex:1; margin:0 15px; background:var(--c-border); height:16px; border-radius:10px; overflow:hidden;">
                    <div id="lesson-progress" style="width:0%; height:100%; background:var(--c-success); transition:width 0.5s;"></div>
                </div>
                <div style="font-weight:bold; color:var(--c-error);">‚ù§Ô∏è ‚àû</div>
            </header>

            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; max-width:600px; margin:0 auto; width:100%;">
                <h2 id="lesson-question" style="margin-bottom:30px; text-align:center;">Cargando...</h2>
                <div id="lesson-options" style="display:grid; gap:10px;"></div>
            </div>

            <div style="position:fixed; bottom:0; left:0; width:100%; padding:20px; background:var(--bg-body); border-top:2px solid var(--c-border);">
                <div id="feedback-msg" style="display:none; margin-bottom:10px; font-weight:bold; text-align:center;"></div>
                <button id="btn-check" class="btn btn-success" onclick="App.game.check()">COMPROBAR</button>
                <button id="btn-next" class="btn btn-primary" onclick="App.game.next()" style="display:none;">CONTINUAR</button>
            </div>
        </section>

        <nav class="bottom-nav" id="main-nav" style="display:none;">
            <div class="nav-item active" onclick="App.router.go('home', this)">
                <svg class="nav-icon-svg" viewBox="0 0 40 40"><path d="M20,5 L35,16 L35,35 L25,35 L25,25 L15,25 L15,35 L5,35 L5,16 Z" /></svg>
            </div>
            <div class="nav-item" onclick="App.router.go('practice', this)">
                <svg class="nav-icon-svg" viewBox="0 0 40 40"><path d="M10,10 h20 v20 h-20 Z M15,15 v10 M20,15 v10 M25,15 v10" fill="none"/></svg>
            </div>
            <div class="nav-item" onclick="App.router.go('profile', this)">
                <svg class="nav-icon-svg" viewBox="0 0 40 40"><circle cx="20" cy="15" r="8" fill="none"/><path d="M5,35 Q20,25 35,35" fill="none"/></svg>
            </div>
        </nav>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuraci√≥n Firebase (Misma API Key)
        const firebaseConfig = {
            apiKey: "AIzaSyCbjOddeT9-VNSUoXuFfwjn2Mcg-PCfpU0",
            authDomain: "duolingo-clone-js.firebaseapp.com",
            projectId: "duolingo-clone-js",
            storageBucket: "duolingo-clone-js.firebasestorage.app",
            messagingSenderId: "537892154680",
            appId: "1:537892154680:web:c7fd4e732cc2cce085e5cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const USERS_COLL = `artifacts/duolingo-clone-v3/public/data/users`;

        // ==========================================
        // DATA STORE (Cursos + Vocab + Lecciones)
        // ==========================================
        const DB = {
            courses: {
                en: {
                    id: 'en', name: 'Ingl√©s', flag: 'üá∫üá∏',
                    vocab: [
                        { t: "Apple", n: "Manzana" }, { t: "Water", n: "Agua" },
                        { t: "Bread", n: "Pan" }, { t: "Milk", n: "Leche" }
                    ],
                    lessons: [
                        [{q:"Traduce 'Water'", opts:["Bread","Water","Milk"], c:1}, {q:"'Manzana' en Ingl√©s", opts:["Apple","Pear","Car"], c:0}],
                        [{q:"I am a boy", opts:["Soy un ni√±o","Soy una ni√±a","Hola"], c:0}, {q:"Traduce 'Red'", opts:["Azul","Rojo","Verde"], c:1}],
                        [{q:"Hello", opts:["Adios","Gracias","Hola"], c:2}, {q:"Good morning", opts:["Buenos d√≠as","Buenas noches","Chau"], c:0}],
                        [{q:"Cat", opts:["Perro","Gato","Pez"], c:1}, {q:"Dog", opts:["Perro","Gato","Ave"], c:0}],
                        [{q:"One", opts:["Uno","Dos","Tres"], c:0}, {q:"Two", opts:["Uno","Dos","Tres"], c:1}]
                    ]
                },
                fr: {
                    id: 'fr', name: 'Franc√©s', flag: 'üá´üá∑',
                    vocab: [
                        { t: "Eau", n: "Agua" }, { t: "Pomme", n: "Manzana" },
                        { t: "Chat", n: "Gato" }, { t: "Rouge", n: "Rojo" }
                    ],
                    lessons: [
                        [{q:"Traduce 'Eau'", opts:["Pan","Agua","Leche"], c:1}, {q:"'Pomme'", opts:["Manzana","Pera","Coche"], c:0}],
                        [{q:"Je suis un gar√ßon", opts:["Soy un ni√±o","Soy una ni√±a","Hola"], c:0}, {q:"Rouge", opts:["Azul","Rojo","Verde"], c:1}]
                    ]
                },
                de: {
                    id: 'de', name: 'Alem√°n', flag: 'üá©üá™',
                    vocab: [{ t: "Wasser", n: "Agua" }, { t: "Brot", n: "Pan" }],
                    lessons: [
                        [{q:"Traduce 'Wasser'", opts:["Bier","Wasser","Milch"], c:1}, {q:"Hallo", opts:["Hola","Adios","Gracias"], c:0}],
                        [{q:"Danke", opts:["Por favor","Gracias","No"], c:1}]
                    ]
                }
            },

            findUser: async (username) => {
                try {
                    const d = await getDoc(doc(db, USERS_COLL, username));
                    return d.exists() ? d.data() : null;
                } catch (e) { console.error(e); return null; }
            },

            saveUser: async (user) => {
                await setDoc(doc(db, USERS_COLL, user.username), user);
            }
        };

        // ==========================================
        // APP CONTROLLER
        // ==========================================
        const App = {
            state: {
                currentUser: null,
                authMode: 'login',
                currentLang: 'en'
            },

            init: async () => {
                // Autenticaci√≥n an√≥nima para conectar a Firebase
                await signInAnonymously(auth);
                
                App.ui.renderLangList();
                
                // Verificar sesi√≥n local
                const lastUser = localStorage.getItem('duo_session_v3');
                if (lastUser) {
                    const btn = document.getElementById('btn-auth-action');
                    if(btn) btn.textContent = "Reconectando...";
                    const user = await DB.findUser(lastUser);
                    if (user) App.auth.startSession(user);
                    else localStorage.removeItem('duo_session_v3');
                }
            },

            // --- AUTH LOGIC (Original Restored) ---
            auth: {
                switchTab: (mode) => {
                    App.state.authMode = mode;
                    document.getElementById('tab-login').classList.toggle('active', mode === 'login');
                    document.getElementById('tab-register').classList.toggle('active', mode === 'register');
                    const btn = document.getElementById('btn-auth-action');
                    btn.textContent = mode === 'login' ? 'INICIAR SESI√ìN' : 'CREAR CUENTA';
                    btn.classList.toggle('btn-primary', mode === 'login');
                    btn.classList.toggle('btn-success', mode === 'register');
                    document.getElementById('auth-error').textContent = '';
                },

                submit: async () => {
                    const userVal = document.getElementById('auth-user').value.trim().toLowerCase();
                    const passVal = document.getElementById('auth-pass').value.trim();
                    const errorMsg = document.getElementById('auth-error');
                    
                    if(!userVal || !passVal) return errorMsg.textContent = "Faltan datos";
                    
                    document.getElementById('btn-auth-action').textContent = "Procesando...";

                    try {
                        const existing = await DB.findUser(userVal);
                        
                        if (App.state.authMode === 'register') {
                            if (existing) throw new Error("Usuario ya existe");
                            const newUser = { username: userVal, password: passVal, xp: 0, streak: 1, level: 0 };
                            await DB.saveUser(newUser);
                            App.auth.startSession(newUser);
                        } else {
                            if (!existing) throw new Error("Usuario no encontrado");
                            if (existing.password !== passVal) throw new Error("Contrase√±a incorrecta");
                            App.auth.startSession(existing);
                        }
                    } catch (e) {
                        errorMsg.textContent = e.message;
                        document.getElementById('btn-auth-action').textContent = App.state.authMode === 'login' ? 'INICIAR SESI√ìN' : 'CREAR CUENTA';
                    }
                },

                startSession: (user) => {
                    App.state.currentUser = user;
                    localStorage.setItem('duo_session_v3', user.username);
                    document.getElementById('view-auth').classList.remove('active');
                    document.getElementById('main-nav').style.display = 'flex';
                    
                    App.ui.updateDashboard();
                    App.ui.renderVocab();
                    App.ui.updateProfile();
                    
                    App.router.go('home');
                },

                logout: () => {
                    localStorage.removeItem('duo_session_v3');
                    location.reload();
                }
            },

            // --- GAME ENGINE ---
            game: {
                data: [], qIndex: 0, levelId: 0, selected: null,

                start: (levelIndex) => {
                    const course = DB.courses[App.state.currentLang];
                    if (!course.lessons[levelIndex]) {
                        alert("Nivel en construcci√≥n");
                        return;
                    }
                    
                    App.game.levelId = levelIndex;
                    App.game.data = course.lessons[levelIndex];
                    App.game.qIndex = 0;
                    
                    document.getElementById('lesson-progress').style.width = '0%';
                    App.router.go('lesson');
                    App.game.renderQ();
                },

                renderQ: () => {
                    const q = App.game.data[App.game.qIndex];
                    document.getElementById('lesson-question').textContent = q.q;
                    const grid = document.getElementById('lesson-options');
                    grid.innerHTML = '';
                    
                    document.getElementById('btn-check').style.display = 'block';
                    document.getElementById('btn-check').disabled = true;
                    document.getElementById('btn-next').style.display = 'none';
                    document.getElementById('feedback-msg').style.display = 'none';
                    App.game.selected = null;

                    q.opts.forEach((opt, idx) => {
                        const btn = document.createElement('div');
                        btn.className = 'option-btn';
                        btn.textContent = opt;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            App.game.selected = idx;
                            document.getElementById('btn-check').disabled = false;
                        };
                        grid.appendChild(btn);
                    });
                },

                check: () => {
                    const q = App.game.data[App.game.qIndex];
                    const isCorrect = App.game.selected === q.c;
                    const btns = document.querySelectorAll('.option-btn');
                    const feed = document.getElementById('feedback-msg');

                    btns[App.game.selected].classList.remove('selected');
                    
                    if (isCorrect) {
                        btns[App.game.selected].classList.add('correct');
                        feed.textContent = "¬°BIEN HECHO!";
                        feed.style.color = "var(--c-success)";
                    } else {
                        btns[App.game.selected].classList.add('wrong');
                        btns[q.c].classList.add('correct');
                        feed.textContent = "Soluci√≥n: " + q.opts[q.c];
                        feed.style.color = "var(--c-error)";
                    }
                    
                    feed.style.display = 'block';
                    document.getElementById('btn-check').style.display = 'none';
                    document.getElementById('btn-next').style.display = 'block';
                    
                    const pct = ((App.game.qIndex + 1) / App.game.data.length) * 100;
                    document.getElementById('lesson-progress').style.width = `${pct}%`;
                },

                next: async () => {
                    App.game.qIndex++;
                    if (App.game.qIndex < App.game.data.length) {
                        App.game.renderQ();
                    } else {
                        // Nivel completado
                        alert("¬°Nivel Completado! +15 XP");
                        const u = App.state.currentUser;
                        u.xp += 15;
                        if(u.level === App.game.levelId) u.level++;
                        await DB.saveUser(u);
                        
                        App.ui.updateDashboard();
                        App.ui.updateProfile();
                        App.router.go('home');
                    }
                },

                quit: () => {
                    if(confirm("¬øSalir? Perder√°s el progreso.")) App.router.go('home');
                }
            },

            // --- UI & ROUTER ---
            router: {
                go: (view, navEl) => {
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'full-screen'));
                    const target = document.getElementById('view-'+view);
                    
                    if (view === 'auth' || view === 'lesson') {
                        target.classList.add('active', 'full-screen');
                    } else {
                        target.classList.add('active');
                    }
                    
                    if(navEl) {
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        navEl.classList.add('active');
                    }
                }
            },

            ui: {
                toggleLang: (s) => document.getElementById('lang-modal').style.display = s ? 'flex' : 'none',
                
                renderLangList: () => {
                    const c = document.getElementById('lang-list');
                    c.innerHTML = '';
                    Object.values(DB.courses).forEach(crs => {
                        const b = document.createElement('div');
                        b.className = 'btn btn-outline';
                        b.innerHTML = `${crs.flag} ${crs.name}`;
                        b.style.marginBottom = '10px';
                        b.onclick = () => { 
                            App.state.currentLang = crs.id; 
                            App.ui.toggleLang(false);
                            App.ui.updateDashboard();
                            App.ui.renderVocab();
                        };
                        c.appendChild(b);
                    });
                },

                updateDashboard: () => {
                    const user = App.state.currentUser;
                    const course = DB.courses[App.state.currentLang];
                    
                    document.getElementById('flag-icon').textContent = course.flag;
                    document.getElementById('dash-streak').textContent = user.streak;
                    document.getElementById('dash-xp').textContent = user.xp;

                    const map = document.getElementById('level-map-container');
                    map.innerHTML = '';

                    // Generar Mapa con L√≥gica ZigZag + Visual Nuevo
                    // Lista de nodos fija para la demo
                    const mapNodes = [
                        { type: 'star' }, { type: 'star' }, 
                        { type: 'chest' }, // Cofre
                        { type: 'star' }, { type: 'owl' }, // B√∫ho 
                        { type: 'star' }, { type: 'trophy' }
                    ];

                    mapNodes.forEach((nodeObj, i) => {
                        const offset = Math.sin(i) * 50; // Efecto ZigZag
                        const levelIndex = (nodeObj.type === 'star' || nodeObj.type === 'trophy') ? i : -1; // Indice de nivel l√≥gico
                        
                        let isLocked = true;
                        let isCurrent = false;
                        let isDone = false;

                        // L√≥gica de estado basada en el nivel del usuario
                        if (i < user.level) isDone = true;
                        if (i === user.level) isCurrent = true;
                        if (i <= user.level) isLocked = false;

                        const el = document.createElement('div');
                        el.style.transform = `translateX(${offset}px)`;

                        if (nodeObj.type === 'owl') {
                            el.className = 'owl-decoration';
                            el.style.marginBottom = '20px';
                        } else if (nodeObj.type === 'chest') {
                            el.className = `map-node ${isLocked ? 'locked' : ''}`;
                            el.innerHTML = `<div class="node-circle" style="background:var(--c-chest); box-shadow:0 8px 0 var(--c-chest-sh); border-radius:16px; width:60px; height:55px;">üéÅ</div>`;
                        } else {
                            // Nivel o Trofeo
                            el.className = `map-node ${isLocked ? 'locked' : ''} ${isCurrent ? 'current' : ''}`;
                            el.innerHTML = `
                                ${isCurrent ? '<div style="position:absolute; top:-30px; font-size:1.5rem; animation:bounce 2s infinite;">üëë</div>' : ''}
                                <div class="node-circle">
                                    <svg class="star-icon" viewBox="0 0 24 24" width="30" height="30">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    ${isDone ? '<div style="position:absolute; bottom:-12px; display:flex; gap:2px; font-size:10px;">‚≠ê‚≠ê‚≠ê</div>' : ''}
                                </div>
                            `;
                            // Solo los niveles (estrellas) inician juego
                            el.onclick = () => {
                                if(isLocked) alert("Nivel Bloqueado");
                                else App.game.start(user.level); // Simplificado: Juega siempre el nivel actual
                            };
                        }
                        map.appendChild(el);
                    });
                },

                renderVocab: () => {
                    const grid = document.getElementById('vocab-grid');
                    grid.innerHTML = '';
                    const words = DB.courses[App.state.currentLang].vocab;
                    
                    words.forEach(w => {
                        const c = document.createElement('div');
                        c.className = 'flip-card';
                        c.innerHTML = `
                            <div class="flip-inner">
                                <div class="flip-front">${w.t}</div>
                                <div class="flip-back">${w.n}</div>
                            </div>
                        `;
                        c.onclick = function() { this.classList.toggle('flipped'); };
                        grid.appendChild(c);
                    });
                },

                updateProfile: () => {
                    const u = App.state.currentUser;
                    document.getElementById('profile-name').textContent = u.username.toUpperCase();
                    document.getElementById('profile-avatar').textContent = u.username.charAt(0).toUpperCase();
                    document.getElementById('profile-streak').textContent = u.streak;
                    document.getElementById('profile-xp').textContent = u.xp;
                }
            }
        };

        window.App = App;
        window.onload = App.init;
    </script>
</body>
</html>